AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Provisions the complete infrastructure for the Telemetry Hub test application,
  including 3 VPCs, a Transit Gateway, EC2 instances, RDS, and SQS.

Parameters:
  MyIP:
    Type: String
    Description: Your personal IP address for RDP/SSH access if needed (e.g., 1.2.3.4/32).
    Default: 0.0.0.0/0

  WindowsAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Description: The latest AMI ID for Windows Server 2022.
    Default: '/aws/service/ami-windows-latest/Windows_Server-2022-English-Full-Base'

  LinuxAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Description: The latest AMI ID for Amazon Linux 2.
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'

  DbMasterUsername:
    Type: String
    Description: Master username for the RDS database.
    Default: dbadmin

  DbMasterPassword:
    Type: String
    Description: Master password for the RDS database.
    Default: ChangeMe123
    MinLength: 8
    NoEcho: true
  
  GoExporterPackageUrl:
    Type: String
    Description: The pre-signed S3 URL for the go-exporter package.

  CSharpProducerPackageUrl:
    Type: String
    Description: The pre-signed S3 URL for the csharp-producer package.

Resources:
  #----------------------------------------------------------------
  # IAM - Role and Profile for EC2 SSM Access
  #----------------------------------------------------------------
  SSMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: TelemetryHubSSMRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: SqsSendMessagePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 'sqs:SendMessage'
                Resource: !GetAtt SqsQueue.Arn

  SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: TelemetryHubSSMInstanceProfile
      Roles:
        - !Ref SSMRole

  #----------------------------------------------------------------
  # NETWORKING - VPCs, Subnets, and Gateways
  #----------------------------------------------------------------
  VPCA:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.10.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - {Key: Name, Value: TelemetryHub-VPC-A-EKS}
        - {Key: kubernetes.io/cluster/telemetry-hub-cluster, Value: shared}

  VPCB:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.20.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{Key: Name, Value: TelemetryHub-VPC-B-Windows}]

  VPCC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.30.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{Key: Name, Value: TelemetryHub-VPC-C-Linux-Data}]

  # --- Subnets for each VPC ---
  SubnetA1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCA
      CidrBlock: 10.10.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - {Key: kubernetes.io/role/elb, Value: "1"}
  SubnetA2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCA
      CidrBlock: 10.10.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - {Key: kubernetes.io/role/elb, Value: "1"}

  SubnetB1Private:
    Type: AWS::EC2::Subnet
    Properties: {VpcId: !Ref VPCB, CidrBlock: 10.20.1.0/24, AvailabilityZone: !Select [0, !GetAZs '']}
  SubnetB1Public:
    Type: AWS::EC2::Subnet
    Properties: {VpcId: !Ref VPCB, CidrBlock: 10.20.2.0/24, AvailabilityZone: !Select [0, !GetAZs ''], MapPublicIpOnLaunch: true}
  
  SubnetC1Private:
    Type: AWS::EC2::Subnet
    Properties: {VpcId: !Ref VPCC, CidrBlock: 10.30.1.0/24, AvailabilityZone: !Select [0, !GetAZs '']}
  SubnetC2Private:
    Type: AWS::EC2::Subnet
    Properties: {VpcId: !Ref VPCC, CidrBlock: 10.30.2.0/24, AvailabilityZone: !Select [1, !GetAZs '']}
  SubnetC1Public:
    Type: AWS::EC2::Subnet
    Properties: {VpcId: !Ref VPCC, CidrBlock: 10.30.3.0/24, AvailabilityZone: !Select [0, !GetAZs ''], MapPublicIpOnLaunch: true}
  SubnetC2Public:
    Type: AWS::EC2::Subnet
    Properties: {VpcId: !Ref VPCC, CidrBlock: 10.30.4.0/24, AvailabilityZone: !Select [1, !GetAZs ''], MapPublicIpOnLaunch: true}

  # --- Internet and NAT Gateways ---
  InternetGatewayA:
    Type: AWS::EC2::InternetGateway
  VPCGatewayAttachmentA:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: {VpcId: !Ref VPCA, InternetGatewayId: !Ref InternetGatewayA}

  InternetGatewayB:
    Type: AWS::EC2::InternetGateway
  VPCGatewayAttachmentB:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: {VpcId: !Ref VPCB, InternetGatewayId: !Ref InternetGatewayB}
  NatGatewayEIPB:
    Type: AWS::EC2::EIP
    Properties: {Domain: vpc}
  NatGatewayB:
    Type: AWS::EC2::NatGateway
    Properties: {AllocationId: !GetAtt NatGatewayEIPB.AllocationId, SubnetId: !Ref SubnetB1Public}

  InternetGatewayC:
    Type: AWS::EC2::InternetGateway
  VPCGatewayAttachmentC:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: {VpcId: !Ref VPCC, InternetGatewayId: !Ref InternetGatewayC}
  NatGatewayEIPC:
    Type: AWS::EC2::EIP
    Properties: {Domain: vpc}
  NatGatewayC:
    Type: AWS::EC2::NatGateway
    Properties: {AllocationId: !GetAtt NatGatewayEIPC.AllocationId, SubnetId: !Ref SubnetC1Public}

  # --- Transit Gateway ---
  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: TGW for Telemetry Hub VPCs
      DefaultRouteTableAssociation: enable
      DefaultRouteTablePropagation: enable
      Tags: [{Key: Name, Value: TelemetryHub-TGW}]

  TGWAttachmentA:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties: {VpcId: !Ref VPCA, SubnetIds: [!Ref SubnetA1, !Ref SubnetA2], TransitGatewayId: !Ref TransitGateway}
  TGWAttachmentB:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties: {VpcId: !Ref VPCB, SubnetIds: [!Ref SubnetB1Private], TransitGatewayId: !Ref TransitGateway}
  TGWAttachmentC:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties: {VpcId: !Ref VPCC, SubnetIds: [!Ref SubnetC1Private, !Ref SubnetC2Private], TransitGatewayId: !Ref TransitGateway}

  # --- Route Tables ---
  RouteTableA:
    Type: AWS::EC2::RouteTable
    Properties: {VpcId: !Ref VPCA}
  RouteTableBPrivate:
    Type: AWS::EC2::RouteTable
    Properties: {VpcId: !Ref VPCB}
  RouteTableBPublic:
    Type: AWS::EC2::RouteTable
    Properties: {VpcId: !Ref VPCB}
  RouteTableCPrivate:
    Type: AWS::EC2::RouteTable
    Properties: {VpcId: !Ref VPCC}
  RouteTableCPublic:
    Type: AWS::EC2::RouteTable
    Properties: {VpcId: !Ref VPCC}

  # --- Routes ---
  DefaultRouteA:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableA, DestinationCidrBlock: '0.0.0.0/0', GatewayId: !Ref InternetGatewayA}
    DependsOn: VPCGatewayAttachmentA
  RouteAtoB:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableA, DestinationCidrBlock: !GetAtt VPCB.CidrBlock, TransitGatewayId: !Ref TransitGateway}
    DependsOn: TGWAttachmentA
  RouteAtoC:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableA, DestinationCidrBlock: !GetAtt VPCC.CidrBlock, TransitGatewayId: !Ref TransitGateway}
    DependsOn: TGWAttachmentA
  
  RouteBtoA:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableBPrivate, DestinationCidrBlock: !GetAtt VPCA.CidrBlock, TransitGatewayId: !Ref TransitGateway}
    DependsOn: TGWAttachmentB
  RouteBtoC:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableBPrivate, DestinationCidrBlock: !GetAtt VPCC.CidrBlock, TransitGatewayId: !Ref TransitGateway}
    DependsOn: TGWAttachmentB
  DefaultRouteBPrivate:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableBPrivate, DestinationCidrBlock: '0.0.0.0/0', NatGatewayId: !Ref NatGatewayB}
  DefaultRouteBPublic:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableBPublic, DestinationCidrBlock: '0.0.0.0/0', GatewayId: !Ref InternetGatewayB}
    DependsOn: VPCGatewayAttachmentB

  RouteCtoA:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableCPrivate, DestinationCidrBlock: !GetAtt VPCA.CidrBlock, TransitGatewayId: !Ref TransitGateway}
    DependsOn: TGWAttachmentC
  RouteCtoB:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableCPrivate, DestinationCidrBlock: !GetAtt VPCB.CidrBlock, TransitGatewayId: !Ref TransitGateway}
    DependsOn: TGWAttachmentC
  DefaultRouteCPrivate:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableCPrivate, DestinationCidrBlock: '0.0.0.0/0', NatGatewayId: !Ref NatGatewayC}
  DefaultRouteCPublic:
    Type: AWS::EC2::Route
    Properties: {RouteTableId: !Ref RouteTableCPublic, DestinationCidrBlock: '0.0.0.0/0', GatewayId: !Ref InternetGatewayC}
    DependsOn: VPCGatewayAttachmentC

  # --- Subnet Route Table Associations ---
  SubnetRouteAssocA1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetA1, RouteTableId: !Ref RouteTableA}
  SubnetRouteAssocA2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetA2, RouteTableId: !Ref RouteTableA}
  SubnetRouteAssocB1Private:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetB1Private, RouteTableId: !Ref RouteTableBPrivate}
  SubnetRouteAssocB1Public:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetB1Public, RouteTableId: !Ref RouteTableBPublic}
  SubnetRouteAssocC1Private:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetC1Private, RouteTableId: !Ref RouteTableCPrivate}
  SubnetRouteAssocC2Private:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetC2Private, RouteTableId: !Ref RouteTableCPrivate}
  SubnetRouteAssocC1Public:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetC1Public, RouteTableId: !Ref RouteTableCPublic}
  SubnetRouteAssocC2Public:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: {SubnetId: !Ref SubnetC2Public, RouteTableId: !Ref RouteTableCPublic}

  #----------------------------------------------------------------
  # SECURITY - Security Groups
  #----------------------------------------------------------------
  WindowsSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow RDP from MyIP
      VpcId: !Ref VPCB
      SecurityGroupIngress:
        - {IpProtocol: tcp, FromPort: 3389, ToPort: 3389, CidrIp: !Ref MyIP}
    DependsOn: [TGWAttachmentA, TGWAttachmentB, TGWAttachmentC]

  LinuxSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH from MyIP and HTTP from VPC A
      VpcId: !Ref VPCC
      SecurityGroupIngress:
        - {IpProtocol: tcp, FromPort: 22, ToPort: 22, CidrIp: !Ref MyIP}
        - {IpProtocol: tcp, FromPort: 8080, ToPort: 8080, CidrIp: !GetAtt VPCA.CidrBlock}
    DependsOn: [TGWAttachmentA, TGWAttachmentB, TGWAttachmentC]

  RdsSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow PostgreSQL from anywhere
      VpcId: !Ref VPCC
      SecurityGroupIngress:
        - {IpProtocol: tcp, FromPort: 5432, ToPort: 5432, CidrIp: "0.0.0.0/0"}
    DependsOn: [TGWAttachmentA, TGWAttachmentB, TGWAttachmentC]

  NodeSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG for EKS worker nodes
      VpcId: !Ref VPCA
      SecurityGroupIngress:
        - IpProtocol: -1
          CidrIp: !GetAtt VPCA.CidrBlock
    DependsOn: VPCA

  #----------------------------------------------------------------
  # DATA & MESSAGING - SQS and RDS
  #----------------------------------------------------------------
  SqsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: TelemetryHubQueue

  RdsDbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for Telemetry Hub RDS
      SubnetIds: [!Ref SubnetC1Public, !Ref SubnetC2Public]
    DependsOn: [SubnetRouteAssocC1Public, SubnetRouteAssocC2Public]

  RdsInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: telemetry-hub-db
      DBName: telemetryhubdb
      DBInstanceClass: db.t3.micro
      Engine: postgres
      EngineVersion: '16'
      AllocatedStorage: '20'
      DBSubnetGroupName: !Ref RdsDbSubnetGroup
      VPCSecurityGroups: [!Ref RdsSG]
      MasterUsername: !Ref DbMasterUsername
      MasterUserPassword: !Ref DbMasterPassword
      PubliclyAccessible: true
      EnableIAMDatabaseAuthentication: true
    DependsOn: [RdsDbSubnetGroup, RdsSG]

  #----------------------------------------------------------------
  # COMPUTE - EC2 Instances
  #----------------------------------------------------------------
  WindowsInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: !Ref WindowsAmiId
      IamInstanceProfile: !Ref SSMInstanceProfile
      SubnetId: !Ref SubnetB1Private
      SecurityGroupIds: [!Ref WindowsSG]
      Tags: [{Key: Name, Value: TelemetryHub-Windows-Producer}]
      UserData:
        Fn::Base64: !Sub |
          <powershell>
          # Set App Directory
          $appDir = "C:\Users\Administrator\telemetry-hub"
          New-Item -ItemType Directory -Path $appDir
          cd $appDir

          # Download and install .NET 6 SDK silently
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri https://dot.net/v1/dotnet-install.ps1 -OutFile .\\dotnet-install.ps1
          .\\dotnet-install.ps1 -Channel 6.0 -InstallDir 'C:\Program Files\dotnet'
          
          # Add dotnet to the system PATH
          $newPath = ('C:\Program Files\dotnet', [Environment]::GetEnvironmentVariable('PATH', 'Machine')) -join ';'
          [Environment]::SetEnvironmentVariable('PATH', $newPath, 'Machine')
          
          # Download and extract the application
          Invoke-WebRequest -Uri "${CSharpProducerPackageUrl}" -OutFile "$appDir\csharp-producer.zip"
          Expand-Archive -Path "$appDir\csharp-producer.zip" -DestinationPath $appDir

          # Set Environment Variable for the application
          [System.Environment]::SetEnvironmentVariable('SQS_QUEUE_URL', '${SqsQueue}', 'Machine')

          # Build and run the application in the background
          dotnet publish -c Release -o ./publish
          Start-Job -ScriptBlock { C:\Users\Administrator\telemetry-hub\publish\DataProducer.exe }
          </powershell>
    DependsOn: [WindowsSG, SSMInstanceProfile, RdsInstance]

  LinuxInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref LinuxAmiId
      IamInstanceProfile: !Ref SSMInstanceProfile
      SubnetId: !Ref SubnetC1Private
      SecurityGroupIds: [!Ref LinuxSG]
      Tags: [{Key: Name, Value: TelemetryHub-Linux-Exporter}]
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y
          yum install -y golang
          
          # Create app directory
          APP_DIR="/home/ssm-user/telemetry-hub/src/go-exporter"
          mkdir -p $APP_DIR
          cd $APP_DIR

          # Download and extract the application
          curl -L "${GoExporterPackageUrl}" -o go-exporter.tar.gz
          tar -xzvf go-exporter.tar.gz
          
          # Set environment variables for the application
          export DB_HOST=${RdsInstance.Endpoint.Address}
          export DB_USER=${DbMasterUsername}
          export DB_NAME=telemetryhubdb
          export DB_PASSWORD=${DbMasterPassword}
          
          # Build and run the application in the background
          go mod tidy
          go build -o exporter .
          nohup ./exporter &> nohup.out &

          # Ensure correct ownership
          chown -R ssm-user:ssm-user /home/ssm-user/telemetry-hub
          
    DependsOn: [LinuxSG, SSMInstanceProfile, RdsInstance]

  #----------------------------------------------------------------
  # IAM - Role for EKS Pod
  #----------------------------------------------------------------
  SqsReaderRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: TelemetryHubSqsReaderRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com # Placeholder, will be updated by eksctl or manually
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SqsReadDeletePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource: !GetAtt SqsQueue.Arn

Outputs:
  VPCAId:
    Description: VPC ID for EKS Cluster
    Value: !Ref VPCA
  VPCBId:
    Description: VPC ID for Windows Host
    Value: !Ref VPCB
  VPCCId:
    Description: VPC ID for Linux Host and Data
    Value: !Ref VPCC
  EKSSubnetIds:
    Description: Comma-separated list of Subnet IDs for the EKS Cluster
    Value: !Sub "${SubnetA1},${SubnetA2}"
  NodeSGroupId:
    Description: Security Group ID for the EKS worker nodes
    Value: !Ref NodeSG
  WindowsInstanceId:
    Description: Instance ID of the Windows VM
    Value: !Ref WindowsInstance
  LinuxInstanceId:
    Description: Instance ID of the Linux VM
    Value: !Ref LinuxInstance
  SqsQueueUrl:
    Description: URL of the SQS Queue
    Value: !Ref SqsQueue
  RdsEndpoint:
    Description: Endpoint address for the RDS database
    Value: !GetAtt RdsInstance.Endpoint.Address
  SqsReaderRoleArn:
    Description: ARN of the IAM Role for the EKS pod
    Value: !GetAtt SqsReaderRole.Arn
